name: Deploy Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [main]

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to staging
        run: |
          echo "Deploying to staging environment..."
          # Th·ª±c t·∫ø s·∫Ω c√≥ commands deploy l√™n server staging
          # V√≠ d·ª•: kubectl apply, helm upgrade, docker-compose pull, etc.

      - name: Run smoke tests
        run: |
          echo "Running smoke tests on staging..."
          # curl health check endpoints
          # Verify basic functionality

      - name: Notify success
        if: success()
        run: echo "‚úÖ Deployment to staging successful"

      - name: Notify failure
        if: failure()
        run: echo "‚ùå Deployment to staging failed"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment:
      name: production
      url: https://api.production.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to production (Blue-Green)
        run: |
          echo "Deploying to production (blue-green deployment)..."
          # 1. Deploy to "green" environment
          # 2. Run health checks
          # 3. Switch traffic t·ª´ blue ‚Üí green
          # 4. Monitor metrics
          # 5. Keep blue l√†m rollback point

      - name: Health check
        run: |
          echo "Running production health checks..."
          # Verify all services are up

      - name: Notify deployment
        run: |
          echo "üöÄ Production deployment completed"
          # Send notification to Slack/Teams

# Metrics to track:
# - Build time: Th·ªùi gian build + test
# - Deploy frequency: S·ªë l·∫ßn deploy/ng√†y
# - Change failure rate: % deploy b·ªã rollback
# - MTTR (Mean Time To Recovery): Th·ªùi gian fix l·ªói production
